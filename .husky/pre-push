#!/usr/bin/env sh
# Husky v9+

set -eu

# --- HARD GUARD: block pushes while on main unless override is set ---
current_branch="$(git rev-parse --abbrev-ref HEAD || true)"
if [ "$current_branch" = "main" ] && [ "${I_KNOW_WHAT_IM_DOING:-0}" != "1" ]; then
  echo "✋ Refusing to push directly to main. Push your branch and open a PR."
  echo "    (Override with I_KNOW_WHAT_IM_DOING=1 if absolutely necessary.)"
  exit 1
fi

# If you still want to verify the actual destination ref, capture STDIN *before* any other commands:
# refs="$(cat || true)"
# if printf "%s\n" "$refs" | grep -qE '\srefs/heads/main$'; then … fi

# --- Your build/dry-run steps (these should come AFTER the guard) ---
pnpm -w nx run sesame.jiode.one:bundle-worker || exit 1

pnpm -s exec wrangler deploy dist/apps/sesame.jiode.one/meta-worker.generated.js \
  --config apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.toml \
  --no-bundle --dry-run || exit 1
