name: Sesame Release to Staging
on:
  push:
    branches: [main]
    paths:
      - 'apps/core/jiode/sesame.jiode.one/**'

jobs:
  staging:
    # bind this job to the staging environment so env secrets flow
    environment: staging
    # (optional) keep your matrix for DRY inputs
    strategy:
      matrix:
        APP_ID: [sesame.jiode.one]
        APP_PATH: [apps/core/jiode/sesame.jiode.one]
        PUBLIC_DIR: [apps/core/jiode/sesame.jiode.one/public]
        WRANGLER_CONFIG:
          - apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.staging.toml
        STAGING_BUCKET: [sesame-data-staging]

    # call the reusable workflow
    uses: wearejiode/syzygy/.github/workflows/_worker-ci.yml@main

    # allow the called workflow to receive all repo/org/env secrets
    secrets: inherit

    permissions:
      contents: read
      id-token: write
      attestations: write

    with:
      app_id: ${{ matrix.APP_ID }}
      app_path: ${{ matrix.APP_PATH }}
      wrangler_config: ${{ matrix.WRANGLER_CONFIG }}
      environment: staging # still fine to pass as an input if the callee uses it
      deploy: true

  post_sync:
    needs: staging
    runs-on: ubuntu-latest
    environment: staging
    strategy:
      matrix:
        APP_ID: [sesame.jiode.one]
        APP_PATH: [apps/core/jiode/sesame.jiode.one]
        PUBLIC_DIR: [apps/core/jiode/sesame.jiode.one/public]
        WRANGLER_CONFIG:
          - apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.staging.toml
        STAGING_BUCKET: [sesame-data-staging]

    # if you want to be explicit here (optional), map secrets to env vars wrangler expects
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }} # env-scoped (staging)
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }} # env-scoped (staging)

    steps:
      - uses: actions/checkout@v4
      - name: Push public assets + data.json to R2 (staging)
        uses: ./.github/actions/sesame/r2-push
        with:
          bucket: ${{ matrix.STAGING_BUCKET }}
          public_dir: ${{ matrix.PUBLIC_DIR }}
          data_json_path: ${{ matrix.APP_PATH }}/data.json
          wrangler_config: ${{ matrix.WRANGLER_CONFIG }}
          wrangler_version: '4.31.0'
