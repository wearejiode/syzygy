name: Sesame Release to Staging

on:
  push:
    branches: [main]
    paths:
      - 'apps/core/jiode/sesame.jiode.one/**'

jobs:
  staging:
    # This job CALLS a reusable workflow; no strategy/matrix/runs-on here
    uses: wearejiode/syzygy/.github/workflows/_worker-ci.yml@main
    secrets:
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_PREVIEW }}
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID_PREVIEW }}
    # If the called workflow needs elevated perms, set them here
    permissions:
      contents: read
      id-token: write
      attestations: write
    # Inputs to the reusable workflow
    with:
      preview_host: staging.jiode.workers.dev
      environment: staging
      app_id: sesame.jiode.one
      app_path: apps/core/jiode/sesame.jiode.one
      wrangler_config: apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.staging.toml
      deploy: true

  post_sync:
    needs: staging
    runs-on: ubuntu-latest
    environment: staging

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN_PREVIEW }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID_PREVIEW }}

    steps:
      - uses: actions/checkout@v4
      - name: Push public assets + data.json to R2 (staging)
        uses: ./.github/actions/sesame/r2-push
        with:
          preview_host: staging.jiode.workers.dev
          bucket: sesame-data-staging
          public_dir: apps/core/jiode/sesame.jiode.one/public
          data_json_path: apps/core/jiode/sesame.jiode.one/data.json
          wrangler_config: apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.staging.toml
          wrangler_version: '4.33.0'
