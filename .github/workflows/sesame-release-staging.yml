name: Sesame Release to Staging

on:
  push:
    branches: [main]
    paths:
      - 'apps/core/jiode/sesame.jiode.one/**'

jobs:
  staging:
    # This job CALLS a reusable workflow; no strategy/matrix/runs-on here
    uses: wearejiode/syzygy/.github/workflows/_worker-ci.yml@main

    # Bind to the staging environment so environment-scoped secrets flow
    environment: staging

    # Let the called workflow receive repo/org/env secrets
    secrets: inherit

    # If the called workflow needs elevated perms, set them here
    permissions:
      contents: read
      id-token: write
      attestations: write

    # Inputs to the reusable workflow
    with:
      app_id: sesame.jiode.one
      app_path: apps/core/jiode/sesame.jiode.one
      wrangler_config: apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.staging.toml
      environment: staging
      deploy: true

  post_sync:
    needs: staging
    runs-on: ubuntu-latest
    environment: staging

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - uses: actions/checkout@v4
      - name: Push public assets + data.json to R2 (staging)
        uses: ./.github/actions/sesame/r2-push
        with:
          bucket: sesame-data-staging
          public_dir: apps/core/jiode/sesame.jiode.one/public
          data_json_path: apps/core/jiode/sesame.jiode.one/data.json
          wrangler_config: apps/core/jiode/sesame.jiode.one/sesame-meta-worker/wrangler.staging.toml
          wrangler_version: '4.31.0'
